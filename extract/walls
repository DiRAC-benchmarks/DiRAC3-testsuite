#!/usr/bin/env python

import sys, argparse, re

def main():

    # Input file from command line arguments
    parser = argparse.ArgumentParser(description="Parse the output of the Walls benchmark for performance metrics")
    parser.add_argument('file', help='The output file to parse')
    args = parser.parse_args()

    # Regex for parsing file
    regex = re.compile(r"(?<=OMP_NUM_THREADS[ =])(?P<ompnumthreads>[0-9]+)\n.*(?<=walls_xeon_[34]d )(?P<gridsize>[0-9]+)(?:[\S\s]*?)(?<=GFLOP/s = )(?P<gflops>[0-9]*\.?[0-9]*)")

    # Open file and parse for data
    try:
        with open(args.file,"r") as openfile:
            data = regex.findall(openfile.read())
            if len(data)==0:
                raise IOError()
    except IOError:
        print "Could not read " + args.file

    # Print heading
    print "Threads   Grid Size   GFLOP/S"

    # Print output
    out_template = "{0:>7}{1:>12}{2:10.2f}"
    for adata in data:
        print out_template.format(adata[0], adata[1], float(adata[2]))

if __name__ == "__main__":
   main()
