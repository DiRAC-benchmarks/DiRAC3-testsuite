# 32 GB
NUM = 4294967296
DRAM_ALLOC = 1073741824L
FILE = dat
NODES = 16

#2048 GB
NUM = 274877906944
DRAM_ALLOC = 8589934592L
FILE = dat
NODES = 256

# 64 KB
NUM = 8192
DRAM_ALLOC = 1024L
FILE = dat
NODES = 16

# 256 MB
NUM = 16777216
DRAM_ALLOC = 524288L
FILE = dat
NODES = 64

# 2 GB
NUM = 268435456
DRAM_ALLOC = 2097152L
FILE = dat
NODES = 128

# 4 GB
NUM = 536870912
DRAM_ALLOC = 2097152L
FILE = dat
NODES = 128

# 256 GB
NUM = 34359738368
#512MB
DRAM_ALLOC = 536870912L
FILE = dat
NODES = 128

# 1 GB
NUM = 134217728
DRAM_ALLOC = 2097152L
FILE = dat
NODES = 128

CXX = $(CPP_BIN)
LD = $(CPP_BIN)

PAGE_SIZE = 4096

OUT_DIR = $(SCRATCH_DIR)/num_$(NUM)_dram_$(DRAM_ALLOC)_nodes_$(NODES)
TEMP_DIR = $(OUT_DIR)/temp

QUEUE_CMD = qsub
CORES = 1
TIME = 120
PROJECT = Performance
ENV = --env VPROF_PROFILE=yes:BGLOCKLESSMPIO_F_TYPE=0x47504653

OPT = 2

BINARY = bigsort

PROF_DIR = .

CFLAGS += -O$(OPT) -g
ifeq ($(OPENMP), yes)
  CFLAGS += $(OPENMP_FLAGS)
endif
ifeq ($(DEBUG), yes)
  CFLAGS += -DDEBUG
endif
ifeq ($(PROF), yes)
  CFLAGS += -DPROF
endif

ifeq ($(CLUSTER),$(filter $(CLUSTER), Mira Vesta))
ifeq ($(OPENMP), yes)
  LFLAGS = ~morozov/HPM/lib/libmpihpm_smp.a /bgsys/drivers/ppcfloor/bgpm/lib/libbgpm.a
else
  LFLAGS = ~morozov/HPM/lib/libmpihpm.a /bgsys/drivers/ppcfloor/bgpm/lib/libbgpm.a
endif
endif

.c.o :
	$(CC) $(CFLAGS) $< -c

.cpp.o :
	$(CXX) $(CFLAGS) $< -c

.f.o :
	$(F90_BIN) $(CFLAGS) $< -c

.c.s :
	$(CC) $(CFLAGS) $< -S

.cpp.s :
	$(CXX) $(CFLAGS) $< -S

.f.s :
	$(F90_BIN) $(CFLAGS) $< -S


all: $(OBJ)
	$(LD) $(CFLAGS) $(OBJ) $(LFLAGS) -o $(BINARY)

clean:
	rm $(OBJ) $(BINARY) *.error *.output *.cobaltlog core.* hpm_* mpi_* vmon*
  
qsub: $(BINARY)
	mkdir -p $(OUT_DIR)
	mkdir -p $(TEMP_DIR)
	$(QUEUE_CMD) -n $(NODES) --mode c$(CORES) -t $(TIME) -A $(PROJECT) $(ENV) $(BINARY) $(NUM) $(DRAM_ALLOC) $(SCRATCH_DIR)/data/$(NUM)_unsorted.$(FILE) $(OUT_DIR)/sorted.$(NUM).$(FILE) $(TEMP_DIR) $(IO_BUF_PAGES) $(PAGE_SIZE)

collect:
	mkdir -p $(PROF_DIR)
	mv hpm_* mpi_* vmon* *.error *.output *.cobaltlog $(PROF_DIR)

