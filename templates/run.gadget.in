#!/usr/bin/env bash
# Run-specific definitions
source ${GADGET3_EAGLE_BENCH_RUN_DEFS}

# Important files and directories
export GADGET_PARAM_TEMPLATE="${DIRAC3_TESTSUITE_TEMPLATES_PATH}/params.gadget.in"
export GADGET_PARAM_FILE="${DIRAC3_TESTSUITE_INPUTS_PATH}/gadget.$GADGET_RUNLABEL.params"
export GADGET_ICS_FILE="${DIRAC3_TESTSUITE_INPUTS_PATH}/$GADGET_DATASET/$GADGET_ICS_NAME"
export GADGET_RUN_DIR="${DIRAC3_TESTSUITE_RUN_PATH}/$GADGET_RUNLABEL"
export GADGET_OUT_DIR="${DIRAC3_TESTSUITE_OUTPUTS_PATH}/$GADGET_RUNLABEL"
export GADGET_COOOLING_TABLES="${DIRAC3_TESTSUITE_INPUTS_PATH}/CoolingTables/"
export GADGET_YIELD_TABLES="${DIRAC3_TESTSUITE_INPUTS_PATH}/YieldTables/"
export GADGET_SNAPLIST_FILE="${DIRAC3_TESTSUITE_INPUTS_PATH}/$GADGET_DATASET/$GADGET_SNAPLIST_NAME"
export GADGET_SNIPLIST_FILE="${DIRAC3_TESTSUITE_INPUTS_PATH}/$GADGET_DATASET/$GADGET_SNIPLIST_NAME"
export GADGET_SNAPSHOT_LINK="$GADGET_OUT_DIR/$GADGET_SNAPSHOT_NAME"

# Ignore buffer alias checks with MPICH
export MPICH_NO_BUFFER_ALIAS_CHECK=1

# Configure parameter file
envsubst < $GADGET_PARAM_TEMPLATE > $GADGET_PARAM_FILE

# Construct the run command
export GADGET_RUN_COMMAND="${MPIEXEC} ${MPIEXEC_NUMPROC_FLAG} $NPROCS ${MPIEXEC_PREFLAGS} ${EXECUTABLE_OUTPUT_PATH}/P-Gadget3 ${MPIEXEC_POSTFLAGS} $GADGET_PARAM_FILE $GADGET_RESTART_FLAG $GADGET_SNAP_ID"

# Create working directory and link data
mkdir -p $GADGET_RUN_DIR
mkdir -p $GADGET_OUT_DIR
ln -s ${DIRAC3_TESTSUITE_INPUTS_PATH}/$GADGET_DATASET/$GADGET_SNAPSHOT_NAME $GADGET_SNAPSHOT_LINK
pushd $GADGET_RUN_DIR

# Run the executable
echo "$GADGET_RUN_COMMAND"
$GADGET_RUN_COMMAND 1> ${DIRAC3_JOB_OUTFILE} 2> ${DIRAC3_JOB_ERRFILE}

# Function to delete any unnecessary files and directories - to be called on exit
function finish {
  popd
}

# Call finish on exit
trap finish EXIT
